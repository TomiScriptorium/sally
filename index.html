<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sally - Preguntas Tontas bienvenidas</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap');

        body {
            font-family: 'Quicksand', sans-serif;
            transition: background-color 0.5s, color 0.5s;
        }

        /* Animación suave para la imagen de Sally */
        .sally-avatar {
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1));
        }

        .sally-avatar:hover {
            transform: scale(1.05) rotate(2deg);
        }

        .thinking .sally-avatar {
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        /* Barra de progreso animada */
        .xp-fill {
            transition: width 1s ease-out;
            background: linear-gradient(90deg, #a78bfa, #8b5cf6);
        }

        /* Markdown simple styling */
        .prose strong { color: #7c3aed; }
        .dark .prose strong { color: #a78bfa; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-top: 0.5rem; }
        .prose li { margin-bottom: 0.25rem; }

        /* Ocultar scrollbar pero permitir scroll */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        sally: {
                            bg: '#fdfbf7', // Crema muy suave
                            dark: '#111827',
                            accent: '#8b5cf6', // Violeta
                            soft: '#eef2ff'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-sally-bg text-gray-700 dark:bg-sally-dark dark:text-gray-200 flex flex-col min-h-screen overflow-x-hidden selection:bg-purple-200 dark:selection:bg-purple-900">

    <!-- Header Flotante -->
    <header class="fixed top-0 w-full p-6 flex justify-between items-center z-50 bg-gradient-to-b from-sally-bg via-sally-bg to-transparent dark:from-sally-dark dark:via-sally-dark">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-sally-accent rounded-full flex items-center justify-center text-white font-bold text-xl shadow-lg">S</div>
            <h1 class="text-xl font-bold tracking-tight text-gray-800 dark:text-white hidden sm:block">Sally.</h1>
        </div>
        
        <div class="flex items-center gap-6">
            <!-- Stats -->
            <div class="flex flex-col items-end cursor-pointer group" onclick="toggleAchievements()">
                <div class="text-xs font-bold uppercase tracking-widest text-gray-400 dark:text-gray-500 mb-1">Nivel <span id="lvl-num">1</span></div>
                <div class="w-32 h-3 bg-gray-200 dark:bg-gray-800 rounded-full overflow-hidden relative shadow-inner">
                    <div id="xp-bar" class="xp-fill h-full w-0 shadow-[0_0_10px_rgba(139,92,246,0.5)]"></div>
                </div>
                <div class="text-[10px] text-sally-accent mt-1 opacity-0 group-hover:opacity-100 transition-opacity absolute top-14">Ver Progreso</div>
            </div>

            <!-- Theme Toggle -->
            <button onclick="toggleTheme()" class="w-10 h-10 rounded-full bg-white dark:bg-gray-800 shadow-md flex items-center justify-center hover:scale-110 transition text-gray-600 dark:text-yellow-400">
                <i class="fas fa-moon dark:hidden"></i>
                <i class="fas fa-sun hidden dark:block"></i>
            </button>
        </div>
    </header>

    <!-- Main Stage -->
    <main class="flex-grow flex flex-col items-center justify-center p-4 w-full max-w-3xl mx-auto mt-10 relative">
        
        <!-- Área de la Mascota (Dinámica) -->
        <div id="sheep-stage" class="relative w-64 h-64 sm:w-80 sm:h-80 mb-8 flex items-center justify-center transition-all duration-500">
            <!-- La imagen se inyecta vía JS -->
            <img id="sally-img" src="tomiscriptorium/sally/sally-d207f810ced7e566d63816a546fab8257544ca56/Gemini_Generated_Image_6jk9y46jk9y46jk9.png" 
                 alt="Sally la Oveja" 
                 class="sally-avatar w-full h-full object-contain">
                 
            <!-- Burbuja de diálogo (inicialmente oculta) -->
            <div id="speech-bubble" class="absolute -top-4 -right-4 bg-white dark:bg-gray-800 p-3 rounded-tr-xl rounded-tl-xl rounded-br-xl shadow-xl text-sm border border-gray-100 dark:border-gray-700 transform scale-0 transition-transform origin-bottom-left max-w-[150px]">
                <p id="bubble-text">¡Beeee!</p>
            </div>
        </div>

        <!-- Título Dinámico -->
        <h2 id="sally-title" class="text-center text-sm font-bold text-sally-accent uppercase tracking-widest mb-6 opacity-80">Sally la Novata</h2>

        <!-- Input Area -->
        <div class="w-full relative z-20 group">
            <div class="absolute inset-0 bg-gradient-to-r from-purple-400 to-pink-400 rounded-3xl blur opacity-20 group-hover:opacity-40 transition duration-500"></div>
            <div class="relative bg-white dark:bg-gray-800 rounded-3xl shadow-2xl flex items-center p-2 border border-gray-100 dark:border-gray-700">
                <input type="text" id="user-input" 
                    placeholder="Escribe aquí... (ej: ¿Cómo se escribe 'hervir'?)" 
                    class="w-full bg-transparent p-4 pl-6 text-lg outline-none text-gray-700 dark:text-gray-200 placeholder-gray-400"
                    autocomplete="off"
                    onkeypress="handleEnter(event)">
                
                <button onclick="askSally()" id="send-btn"
                    class="bg-sally-accent hover:bg-purple-600 text-white p-4 rounded-2xl transition-all shadow-lg transform active:scale-95 flex-shrink-0 w-14 h-14 flex items-center justify-center">
                    <i class="fas fa-arrow-up"></i>
                </button>
            </div>
            <p class="text-center text-xs text-gray-400 mt-4 flex items-center justify-center gap-2">
                <i class="fas fa-user-secret"></i> Modo Privado: Tu secreto está a salvo conmigo.
            </p>
        </div>

        <!-- Response Area -->
        <div id="response-container" class="w-full mt-10 hidden opacity-0 transition-all duration-700 transform translate-y-4">
            <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md p-8 rounded-3xl shadow-xl border border-purple-100 dark:border-purple-900/30">
                <div class="flex items-start gap-4">
                    <div class="text-sally-accent text-2xl mt-1"><i class="fas fa-quote-left"></i></div>
                    <div class="prose dark:prose-invert flex-grow text-lg leading-relaxed" id="response-text">
                        <!-- Respuesta aquí -->
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button onclick="copyResponse()" class="text-xs font-bold text-gray-400 hover:text-sally-accent transition flex items-center gap-1">
                        <i class="far fa-copy"></i> COPIAR
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal de Logros / Niveles -->
    <div id="achievements-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4" onclick="closeAchievements(event)">
        <div class="bg-white dark:bg-gray-900 w-full max-w-md rounded-3xl shadow-2xl overflow-hidden transform scale-95 transition-all duration-300" id="modal-content">
            <div class="p-6 bg-gradient-to-r from-purple-600 to-indigo-600 text-white relative overflow-hidden">
                <i class="fas fa-trophy absolute -right-6 -bottom-6 text-9xl text-white opacity-10"></i>
                <h2 class="text-2xl font-bold relative z-10">Trayectoria Lanuda</h2>
                <p class="text-purple-100 text-sm relative z-10">Desbloquea nuevas formas de Sally.</p>
            </div>
            <div class="p-6 max-h-[60vh] overflow-y-auto no-scrollbar" id="levels-list">
                <!-- Se llena con JS -->
            </div>
            <div class="p-4 bg-gray-50 dark:bg-gray-900/50 text-center border-t dark:border-gray-800">
                <button onclick="toggleAchievements()" class="text-sm font-bold text-gray-500 hover:text-gray-800 dark:hover:text-white transition">CERRAR</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-900 dark:bg-white text-white dark:text-gray-900 px-6 py-3 rounded-full shadow-2xl font-bold translate-y-20 opacity-0 transition-all duration-500 z-[70] flex items-center gap-3">
        <i class="fas fa-star text-yellow-400"></i> <span id="toast-msg">¡Nivel Subido!</span>
    </div>

    <!-- Confetti Container -->
    <div id="confetti-container" class="fixed inset-0 pointer-events-none z-[80] overflow-hidden"></div>

    <script>
        // --- CONFIGURACIÓN ---
        const apiKey = ""; // La API Key se inyectará automáticamente
        
        // Rutas de las imágenes proporcionadas
        const SHEEP_IMAGES = {
            base: "tomiscriptorium/sally/sally-d207f810ced7e566d63816a546fab8257544ca56/Gemini_Generated_Image_6jk9y46jk9y46jk9.png",      // Sentada (Lvl 1-2)
            stand: "tomiscriptorium/sally/sally-d207f810ced7e566d63816a546fab8257544ca56/Gemini_Generated_Image_5hn0365hn0365hn0.png",     // De pie (Lvl 3-4)
            cool: "tomiscriptorium/sally/sally-d207f810ced7e566d63816a546fab8257544ca56/Gemini_Generated_Image_yshtwdyshtwdysht.png",      // Cool (Lvl 5-6)
            happy: "tomiscriptorium/sally/sally-d207f810ced7e566d63816a546fab8257544ca56/Gemini_Generated_Image_eem8s5eem8s5eem8.png",     // Feliz (Lvl 7-8)
            hero: "tomiscriptorium/sally/sally-d207f810ced7e566d63816a546fab8257544ca56/Gemini_Generated_Image_3jhf333jhf333jhf.png",      // Héroe (Lvl 9)
            queen: "tomiscriptorium/sally/sally-d207f810ced7e566d63816a546fab8257544ca56/Gemini_Generated_Image_f8y2wdf8y2wdf8y2.png"      // Reina (Lvl 10)
        };

        // Niveles y Requisitos
        const LEVELS = [
            { lvl: 1, xp: 0, title: "Sally la Novata", img: SHEEP_IMAGES.base, desc: "Recién llegada al prado." },
            { lvl: 2, xp: 100, title: "Sally Curiosa", img: SHEEP_IMAGES.base, desc: "Empieza a balar con sentido." },
            { lvl: 3, xp: 250, title: "Sally de Pie", img: SHEEP_IMAGES.stand, desc: "Ya camina sobre dos patas." },
            { lvl: 4, xp: 450, title: "Sally Presentadora", img: SHEEP_IMAGES.stand, desc: "Explica cosas simples." },
            { lvl: 5, xp: 700, title: "Sally con Estilo", img: SHEEP_IMAGES.cool, desc: "Demasiado cool para el rebaño." },
            { lvl: 6, xp: 1000, title: "Sally Influencer", img: SHEEP_IMAGES.cool, desc: "Marca tendencia lanuda." },
            { lvl: 7, xp: 1350, title: "Sally Eufórica", img: SHEEP_IMAGES.happy, desc: "La felicidad del conocimiento." },
            { lvl: 8, xp: 1750, title: "Sally Bailarina", img: SHEEP_IMAGES.happy, desc: "Baila al ritmo de las respuestas." },
            { lvl: 9, xp: 2200, title: "Super Sally", img: SHEEP_IMAGES.hero, desc: "Salvando al mundo, una duda a la vez." },
            { lvl: 10, xp: 3000, title: "Reina Sally", img: SHEEP_IMAGES.queen, desc: "La soberana absoluta de la sabiduría tonta." }
        ];

        // Estado del Juego
        let state = {
            xp: 0,
            level: 1
        };

        // --- INICIALIZACIÓN ---
        window.onload = function() {
            loadState();
            renderUI();
            checkTheme();
            
            // Mensaje de bienvenida aleatorio en burbuja
            setTimeout(() => showBubble("¡Pregúntame lo que sea!"), 1000);
        };

        // --- LÓGICA DE JUEGO ---

        function handleEnter(e) {
            if (e.key === 'Enter') askSally();
        }

        async function askSally() {
            const input = document.getElementById('user-input');
            const question = input.value.trim();
            const container = document.getElementById('response-container');
            const textBox = document.getElementById('response-text');
            const sheepStage = document.getElementById('sheep-stage');

            if (!question) return;

            // UI Loading
            input.disabled = true;
            document.getElementById('send-btn').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            sheepStage.classList.add('thinking'); // Activa animación de salto
            container.classList.add('hidden');
            container.classList.remove('opacity-100', 'translate-y-0');
            showBubble("Mmmm... déjame pensar...");

            try {
                // Generar Prompt
                const systemPrompt = `
                    Eres Sally, una oveja inteligente, adorable y muy servicial.
                    Este es un buscador exclusivo para "preguntas tontas" o básicas, por lo que TU REGLA DE ORO es: Jamás juzgar, jamás hacer sentir mal al usuario por no saber algo.
                    
                    Instrucciones de Personalidad:
                    1. Tono: Amigable, suave, un poco juguetón (puedes decir "Beeeee" sutilmente si encaja).
                    2. Formato: Respuestas concisas (máximo 3 párrafos breves). Usa negritas para resaltar lo importante.
                    3. Misión: Explicar lo complejo de forma extremadamente simple (ELI5 - Explain Like I'm 5).
                    4. Si preguntan ortografía, diles la respuesta directa y un truco para recordar.
                    5. Si preguntan algo absurdo, sígueles el juego con humor blanco.
                    
                    Pregunta del usuario: "${question}"
                `;

                // Llamada API
                const answer = await fetchGemini(systemPrompt);

                // UI Success
                textBox.innerHTML = parseMarkdown(answer);
                container.classList.remove('hidden');
                // Forzar reflow para animación
                void container.offsetWidth; 
                container.classList.add('opacity-100', 'translate-y-0');
                
                showBubble("¡Lo tengo!");
                
                // Dar Experiencia (Gamificación)
                addXP(30 + Math.floor(Math.random() * 20)); // 30-50 XP

            } catch (error) {
                console.error(error);
                textBox.innerHTML = "Beeeee... (Mi cerebro de algodón de azúcar se desconectó. Intenta de nuevo).";
                container.classList.remove('hidden');
                container.classList.add('opacity-100', 'translate-y-0');
                showBubble("¡Ups!");
            } finally {
                input.disabled = false;
                input.value = '';
                input.focus();
                document.getElementById('send-btn').innerHTML = '<i class="fas fa-arrow-up"></i>';
                sheepStage.classList.remove('thinking');
            }
        }

        async function fetchGemini(prompt) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) {
                // Mock de respuesta si no hay API Key configurada
                if(apiKey === "") return "Necesitas configurar la **API Key** en el código para que yo funcione realmente. Pero como soy una oveja simulada, te diré esto: **Beeeeee**. (Esa es la respuesta a todo).";
                throw e;
            }
        }

        // --- SISTEMA DE XP Y NIVELES ---

        function addXP(amount) {
            const oldLevel = state.level;
            state.xp += amount;

            // Calcular nuevo nivel
            let newLevel = 1;
            for (let i = 0; i < LEVELS.length; i++) {
                if (state.xp >= LEVELS[i].xp) {
                    newLevel = LEVELS[i].lvl;
                }
            }
            
            // Guardar y Renderizar
            state.level = newLevel;
            saveState();
            renderUI();

            // Evento de Subida de Nivel
            if (newLevel > oldLevel) {
                celebrateLevelUp(newLevel);
            }
        }

        function renderUI() {
            // Datos del nivel actual y siguiente
            const currentLvlData = LEVELS.find(l => l.lvl === state.level);
            const nextLvlData = LEVELS.find(l => l.lvl === state.level + 1) || { xp: state.xp * 1.5 }; // Cap ficticio
            
            // Actualizar texto
            document.getElementById('lvl-num').innerText = state.level;
            document.getElementById('sally-title').innerText = currentLvlData.title;

            // Actualizar imagen de Sally
            const sheepImg = document.getElementById('sally-img');
            if (sheepImg.src !== currentLvlData.img && !sheepImg.src.includes(currentLvlData.img)) {
                // Fade out, cambio, Fade in
                sheepImg.style.opacity = 0;
                setTimeout(() => {
                    sheepImg.src = currentLvlData.img;
                    sheepImg.style.opacity = 1;
                }, 300);
            }

            // Actualizar barra XP
            const prevThreshold = LEVELS.find(l => l.lvl === state.level).xp;
            const nextThreshold = nextLvlData.xp;
            // Calcular porcentaje dentro del nivel actual
            let percentage = 0;
            if (state.level < 10) {
                 percentage = ((state.xp - prevThreshold) / (nextThreshold - prevThreshold)) * 100;
            } else {
                percentage = 100; // Max nivel
            }
            document.getElementById('xp-bar').style.width = `${Math.max(5, Math.min(100, percentage))}%`;

            renderAchievementsList();
        }

        function renderAchievementsList() {
            const list = document.getElementById('levels-list');
            list.innerHTML = LEVELS.map(lvl => {
                const locked = state.level < lvl.lvl;
                const isCurrent = state.level === lvl.lvl;
                
                return `
                    <div class="flex items-center gap-4 mb-3 p-3 rounded-xl border transition-all ${
                        locked 
                        ? 'bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700 opacity-60 grayscale' 
                        : (isCurrent ? 'bg-purple-50 dark:bg-purple-900/30 border-purple-300 dark:border-purple-500 ring-1 ring-purple-200' : 'bg-white dark:bg-gray-800 border-gray-100 dark:border-gray-700')
                    }">
                        <div class="relative w-12 h-12 flex-shrink-0">
                            <img src="${lvl.img}" class="w-full h-full object-contain">
                            ${locked ? '<div class="absolute inset-0 flex items-center justify-center bg-black/10 rounded-full"><i class="fas fa-lock text-gray-500"></i></div>' : ''}
                        </div>
                        <div class="flex-grow">
                            <h4 class="font-bold text-sm ${isCurrent ? 'text-purple-600 dark:text-purple-300' : 'text-gray-700 dark:text-gray-300'}">
                                Nivel ${lvl.lvl}: ${lvl.title}
                            </h4>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${lvl.desc}</p>
                        </div>
                        <div class="text-xs font-mono text-gray-400">
                            ${lvl.xp} XP
                        </div>
                    </div>
                `;
            }).join('');
        }

        function celebrateLevelUp(lvl) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = `¡Nivel ${lvl} alcanzado!`;
            
            // Show Toast
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 4000);

            // Confetti
            createConfetti();
            showBubble("¡Me siento más lista!");
        }

        // --- EFECTOS VISUALES ---

        function showBubble(text) {
            const bubble = document.getElementById('speech-bubble');
            document.getElementById('bubble-text').innerText = text;
            bubble.classList.remove('scale-0');
            setTimeout(() => bubble.classList.add('scale-0'), 3000);
        }

        function createConfetti() {
            const container = document.getElementById('confetti-container');
            const colors = ['#8b5cf6', '#ec4899', '#f59e0b', '#10b981'];
            
            for (let i = 0; i < 50; i++) {
                const conf = document.createElement('div');
                conf.style.position = 'absolute';
                conf.style.width = '10px';
                conf.style.height = '10px';
                conf.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.top = '-10px';
                conf.style.transform = `rotate(${Math.random() * 360}deg)`;
                conf.style.transition = `top ${Math.random() * 2 + 2}s ease-in, transform 2s linear`;
                
                container.appendChild(conf);

                // Start animation
                setTimeout(() => {
                    conf.style.top = '105vh';
                    conf.style.transform = `rotate(${Math.random() * 360 + 360}deg)`;
                }, 10);

                // Cleanup
                setTimeout(() => conf.remove(), 4000);
            }
        }

        // --- UTILIDADES ---

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('sally_theme', isDark ? 'dark' : 'light');
        }

        function checkTheme() {
            const saved = localStorage.getItem('sally_theme');
            if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        }

        function saveState() {
            localStorage.setItem('sally_gamestate', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('sally_gamestate');
            if (saved) state = JSON.parse(saved);
        }

        function toggleAchievements() {
            const modal = document.getElementById('achievements-modal');
            const content = document.getElementById('modal-content');
            
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => content.classList.remove('scale-95'), 10);
            } else {
                content.classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        function closeAchievements(e) {
            if (e.target.id === 'achievements-modal') toggleAchievements();
        }

        function copyResponse() {
            const text = document.getElementById('response-text').innerText;
            navigator.clipboard.writeText(text);
            showBubble("Copiado al portapapeles");
        }

        function parseMarkdown(text) {
            if (!text) return '';
            let html = text
                .replace(/^### (.*$)/gim, '<h3 class="font-bold text-lg mt-2 mb-1">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="font-bold text-xl mt-3 mb-2">$1</h2>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
            return html;
        }
    </script>
</body>
</html>
